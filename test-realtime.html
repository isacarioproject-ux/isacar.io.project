<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Realtime ISACAR</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0f172a;
      color: #f1f5f9;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 600;
    }
    .success { background: #10b981; color: white; }
    .error { background: #ef4444; color: white; }
    .info { background: #3b82f6; color: white; }
    .warning { background: #f59e0b; color: white; }
    pre {
      background: #1e293b;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    .pulse {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <h1>üîç Teste de Realtime - ISACAR.dev</h1>
  
  <div id="status" class="status info">
    <span class="pulse"></span> Aguardando teste...
  </div>

  <div>
    <button onclick="testConnection()">1. Testar Conex√£o</button>
    <button onclick="testRealtimeSubscription()">2. Testar Subscri√ß√£o</button>
    <button onclick="testInsert()">3. Simular INSERT</button>
  </div>

  <h2>üìã Logs:</h2>
  <pre id="logs">Aguardando a√ß√µes...</pre>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const SUPABASE_URL = 'https://jjeudthfiqvvauuqnezs.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZXVkdGhmaXF2dmF1dXFuZXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzIyMTEsImV4cCI6MjA3NjkwODIxMX0.EDznlxVY-xiuAGAdVKP9cj9Fh_MBM6GhddO3RjD3qx8'

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.channel = null

    const statusEl = document.getElementById('status')
    const logsEl = document.getElementById('logs')

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('pt-BR')
      const emoji = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      }[type]
      
      logsEl.textContent += `\n[${timestamp}] ${emoji} ${message}`
      logsEl.scrollTop = logsEl.scrollHeight
    }

    function setStatus(message, type) {
      statusEl.className = `status ${type}`
      statusEl.innerHTML = type === 'success' 
        ? `<span class="pulse"></span> ${message}`
        : message
    }

    window.testConnection = async () => {
      log('Testando conex√£o com Supabase...', 'info')
      
      try {
        const { data: { user }, error } = await window.supabase.auth.getUser()
        
        if (error) {
          log(`Erro ao buscar usu√°rio: ${error.message}`, 'error')
          setStatus('‚ùå N√£o autenticado', 'error')
          return
        }

        if (!user) {
          log('Usu√°rio n√£o est√° logado', 'warning')
          setStatus('‚ö†Ô∏è Fa√ßa login primeiro', 'warning')
          return
        }

        log(`Conectado como: ${user.email}`, 'success')
        log(`User ID: ${user.id}`, 'info')
        setStatus(`‚úÖ Conectado: ${user.email}`, 'success')

        // Buscar workspaces
        const { data: workspaces, error: wsError } = await window.supabase
          .from('workspace_members')
          .select('workspace_id, workspaces(id, name)')
          .eq('user_id', user.id)

        if (wsError) {
          log(`Erro ao buscar workspaces: ${wsError.message}`, 'error')
          return
        }

        log(`Workspaces encontrados: ${workspaces?.length || 0}`, 'info')
        workspaces?.forEach(ws => {
          log(`  - ${ws.workspaces.name} (ID: ${ws.workspace_id})`, 'info')
        })

      } catch (error) {
        log(`Erro: ${error.message}`, 'error')
        setStatus('‚ùå Erro na conex√£o', 'error')
      }
    }

    window.testRealtimeSubscription = async () => {
      log('Testando subscri√ß√£o Realtime...', 'info')

      try {
        const { data: { user } } = await window.supabase.auth.getUser()
        if (!user) {
          log('Usu√°rio n√£o autenticado', 'error')
          return
        }

        // Buscar primeiro workspace
        const { data: workspaces } = await window.supabase
          .from('workspace_members')
          .select('workspace_id')
          .eq('user_id', user.id)
          .limit(1)

        if (!workspaces || workspaces.length === 0) {
          log('Nenhum workspace encontrado', 'error')
          return
        }

        const workspaceId = workspaces[0].workspace_id
        log(`Subscrevendo ao workspace: ${workspaceId}`, 'info')

        // Remover canal anterior se existir
        if (window.channel) {
          window.supabase.removeChannel(window.channel)
          log('Canal anterior removido', 'info')
        }

        // Criar novo canal
        window.channel = window.supabase
          .channel(`test-tasks-${workspaceId}`)
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'tasks',
              filter: `workspace_id=eq.${workspaceId}`
            },
            (payload) => {
              log(`üéâ EVENTO REALTIME RECEBIDO!`, 'success')
              log(`Tipo: ${payload.eventType}`, 'info')
              log(`Tabela: ${payload.table}`, 'info')
              log(`Dados: ${JSON.stringify(payload.new || payload.old, null, 2)}`, 'info')
              setStatus(`üî• Realtime funcionando! Evento: ${payload.eventType}`, 'success')
            }
          )
          .subscribe((status) => {
            log(`Status do canal: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning')
            if (status === 'SUBSCRIBED') {
              setStatus('üü¢ Realtime ativo e escutando...', 'success')
            }
          })

      } catch (error) {
        log(`Erro ao subscrever: ${error.message}`, 'error')
        setStatus('‚ùå Erro na subscri√ß√£o', 'error')
      }
    }

    window.testInsert = async () => {
      log('Simulando INSERT de task...', 'info')

      try {
        const { data: { user } } = await window.supabase.auth.getUser()
        if (!user) {
          log('Usu√°rio n√£o autenticado', 'error')
          return
        }

        const { data: workspaces } = await window.supabase
          .from('workspace_members')
          .select('workspace_id')
          .eq('user_id', user.id)
          .limit(1)

        if (!workspaces || workspaces.length === 0) {
          log('Nenhum workspace encontrado', 'error')
          return
        }

        const workspaceId = workspaces[0].workspace_id

        const newTask = {
          title: `Teste Realtime ${new Date().toLocaleTimeString()}`,
          description: 'Task criada pelo script de teste',
          status: 'todo',
          priority: 'medium',
          workspace_id: workspaceId,
          created_by: user.id,
          assignee_ids: [user.id]
        }

        log('Inserindo task no Supabase...', 'info')
        const { data, error } = await window.supabase
          .from('tasks')
          .insert(newTask)
          .select()
          .single()

        if (error) {
          log(`Erro ao inserir: ${error.message}`, 'error')
          setStatus('‚ùå Erro ao criar task', 'error')
          return
        }

        log(`Task criada com ID: ${data.id}`, 'success')
        log('Aguardando evento Realtime...', 'info')
        setStatus('‚è≥ Task criada, aguardando Realtime...', 'warning')

      } catch (error) {
        log(`Erro: ${error.message}`, 'error')
        setStatus('‚ùå Erro ao criar task', 'error')
      }
    }

    // Auto-executar teste de conex√£o
    log('Script carregado. Execute os testes acima.', 'info')
  </script>
</body>
</html>
