import { updateTask, deleteTask, getUsers } from '@/lib/tasks/tasks-storage';
import { useState } from 'react';
import { motion } from 'framer-motion';
import { Task } from '@/types/tasks';
import { TaskRowActionsPopover } from '@/components/tasks/task-row-actions-popover';
import { Checkbox } from '@/components/ui/checkbox';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Calendar as CalendarComponent } from '@/components/ui/calendar';
import { Trash2, Calendar, Pencil, MoreVertical, UserPlus, Flag, CheckCircle2, Settings } from 'lucide-react';
import { toast } from 'sonner';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { useWorkspace } from '@/contexts/workspace-context';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import { useI18n } from '@/hooks/use-i18n';

export interface TaskRowProps {
  task: Task;
  onTaskClick: (taskId: string) => void;
  onUpdate: () => void;
  simplified?: boolean;
}

export function TaskRow({ task, onTaskClick, onUpdate, simplified = false }: TaskRowProps) {
  const { t } = useI18n();
  const { currentWorkspace } = useWorkspace();
  const users = getUsers();
  const assignees = users.filter(u => task.assignee_ids.includes(u.id));
  const today = new Date().toISOString().split('T')[0];
  const isOverdue = task.due_date && task.due_date < today && task.status !== 'done';
  const [showCalendar, setShowCalendar] = useState(false);
  const [showPriority, setShowPriority] = useState(false);
  const [showAssignee, setShowAssignee] = useState(false);
  const [showActions, setShowActions] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date | undefined>(
    task.due_date ? new Date(task.due_date) : undefined
  );

  const handleStatusToggle = (e: React.MouseEvent) => {
    e.stopPropagation();
    const newStatus = task.status === 'done' ? 'todo' : 'done';
    const updates: Partial<Task> = {
      status: newStatus,
      completed_at: newStatus === 'done' ? new Date().toISOString() : null,
    };
    
    updateTask(task.id, updates);
    toast.success(newStatus === 'done' ? 'Tarefa conclu√≠da!' : 'Tarefa reaberta');
    onUpdate();
  };

  const handleDelete = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
      deleteTask(task.id);
      toast.success('Tarefa exclu√≠da');
      onUpdate();
    }
  };

  const priorityIcons: Record<string, string> = {
    urgent: 'üî¥',
    high: 'üè≥Ô∏è',
    medium: 'üü°',
    low: 'üü¢',
  };

  const priorityLabels: Record<string, string> = {
    urgent: 'Urgente',
    high: 'Alta',
    medium: 'M√©dia',
    low: 'Baixa',
  };

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
  };

  return (
    <div
      className="group flex items-center gap-1.5 py-1 px-1.5 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-md cursor-pointer transition-colors w-full"
      onClick={() => onTaskClick(task.id)}
    >
      {/* Checkbox Status */}
      <div onClick={handleStatusToggle}>
        <Checkbox checked={task.status === 'done'} />
      </div>

      {/* T√≠tulo */}
      <div className="flex-1 min-w-0">
        <div
          className={`text-xs truncate ${
            task.status === 'done' ? 'line-through text-gray-400 dark:text-gray-500' : 'dark:text-gray-100'
          }`}
        >
          {task.title}
        </div>

        {/* Badges/Localiza√ß√£o - Ocultar em cards pequenos */}
        {!simplified && (
          <div className="hidden xl:flex items-center gap-1 mt-0.5">
            {task.location && (
              <Badge variant="secondary" className="text-[10px] h-4 px-1">
                {task.location}
              </Badge>
            )}
            {task.workspace && (
              <span className="text-[10px] text-gray-500 dark:text-gray-400">{task.workspace}</span>
            )}
          </div>
        )}
      </div>

      {/* Respons√°veis - Mostrar apenas 1 avatar */}
      {!simplified && assignees.length > 0 && (
        <div className="hidden md:flex items-center gap-0.5">
          <Avatar className="size-4">
            <AvatarFallback className="text-[8px]">{assignees[0].avatar || assignees[0].name.substring(0, 2)}</AvatarFallback>
          </Avatar>
          {assignees.length > 1 && (
            <span className="text-[10px] text-gray-500">+{assignees.length - 1}</span>
          )}
        </div>
      )}

      {/* Data de Vencimento - Compacta */}
      {!simplified && task.due_date && (
        <div
          className={`hidden lg:flex items-center gap-0.5 text-[10px] ${
            isOverdue ? 'text-red-500 dark:text-red-400' : 'text-gray-600 dark:text-gray-400'
          }`}
          title="Data de vencimento"
        >
          <Calendar className="size-2.5" />
          <span className="whitespace-nowrap">{formatDate(task.due_date)}</span>
        </div>
      )}

      {/* Prioridade - Menor */}
      {!simplified && (
        <div
          className="hidden xl:block text-sm"
          title={priorityLabels[task.priority]}
        >
          {priorityIcons[task.priority]}
        </div>
      )}

      {/* A√ß√µes - √çcone √∫nico de Settings com Popover Moderno */}
      <div className="opacity-0 group-hover:opacity-100 transition-opacity flex items-center flex-shrink-0">
        <TaskRowActionsPopover task={task} onUpdate={onUpdate} />
      </div>
    </div>
  );
}
                <button
                  key={user.id}
                  onClick={(e) => {
                    e.stopPropagation();
                    const newAssignees = task.assignee_ids.includes(user.id)
                      ? task.assignee_ids.filter(id => id !== user.id)
                      : [...task.assignee_ids, user.id];
                    updateTask(task.id, { assignee_ids: newAssignees });
                    toast.success(task.assignee_ids.includes(user.id) ? 'Atribui√ß√£o removida' : 'Tarefa atribu√≠da');
                    onUpdate();
                    setShowAssignee(false);
                  }}
                  className="flex items-center gap-2 w-full px-2 py-1.5 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-800"
                >
                  <Avatar className="size-6">
                    <AvatarFallback className="text-xs bg-blue-500 text-white">
                      {user.name.substring(0, 2).toUpperCase()}
                    </AvatarFallback>
                  </Avatar>
                  <span className="dark:text-white">{user.name}</span>
                  {task.assignee_ids.includes(user.id) && (
                    <CheckCircle2 className="size-4 ml-auto text-blue-600" />
                  )}
                </button>
              ))}
            </div>
          </PopoverContent>
        </Popover>

        {/* Alterar data com Calend√°rio */}
        <Popover open={showCalendar} onOpenChange={setShowCalendar}>
          <PopoverTrigger asChild>
            <motion.button
              whileHover={{ scale: 1.1 }}
              whileTap={{ scale: 0.9 }}
              onClick={(e) => e.stopPropagation()}
              className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              title={t('tasks.row.changeDate')}
            >
              <Calendar className="size-3.5" />
            </motion.button>
          </PopoverTrigger>
          <PopoverContent className="w-auto p-0" align="start">
            <div className="p-3 border-b dark:border-gray-700">
              <p className="text-sm font-medium dark:text-white">{t('tasks.quickAdd.selectDate')}</p>
            </div>
            <CalendarComponent
              mode="single"
              selected={selectedDate}
              onSelect={(date) => {
                if (date) {
                  setSelectedDate(date);
                  updateTask(task.id, { due_date: format(date, 'yyyy-MM-dd') });
                  toast.success('Data atualizada');
                  onUpdate();
                  setShowCalendar(false);
                }
              }}
              locale={ptBR}
              className="rounded-md border-0"
            />
            <div className="p-3 border-t dark:border-gray-700 space-y-1">
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  const today = new Date();
                  setSelectedDate(today);
                  updateTask(task.id, { due_date: format(today, 'yyyy-MM-dd') });
                  toast.success('Data definida para hoje');
                  onUpdate();
                  setShowCalendar(false);
                }}
                className="w-full px-3 py-1.5 text-sm text-left rounded hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-white"
              >
                {t('tasks.common.today')}
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  const tomorrow = new Date();
                  tomorrow.setDate(tomorrow.getDate() + 1);
                  setSelectedDate(tomorrow);
                  updateTask(task.id, { due_date: format(tomorrow, 'yyyy-MM-dd') });
                  toast.success('Data definida para amanh√£');
                  onUpdate();
                  setShowCalendar(false);
                }}
                className="w-full px-3 py-1.5 text-sm text-left rounded hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-white"
              >
                {t('tasks.common.tomorrow')}
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  const nextWeek = new Date();
                  nextWeek.setDate(nextWeek.getDate() + 7);
                  setSelectedDate(nextWeek);
                  updateTask(task.id, { due_date: format(nextWeek, 'yyyy-MM-dd') });
                  toast.success('Data definida para pr√≥xima semana');
                  onUpdate();
                  setShowCalendar(false);
                }}
                className="w-full px-3 py-1.5 text-sm text-left rounded hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-white"
              >
                {t('tasks.common.nextWeek')}
              </button>
              {task.due_date && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setSelectedDate(undefined);
                    updateTask(task.id, { due_date: null });
                    toast.success('Data removida');
                    onUpdate();
                    setShowCalendar(false);
                  }}
                  className="w-full px-3 py-1.5 text-sm text-left rounded hover:bg-red-50 dark:hover:bg-red-950 text-red-600 dark:text-red-400"
                >
                  {t('tasks.toast.dateRemoved')}
                </button>
              )}
            </div>
          </PopoverContent>
        </Popover>

        {/* Definir prioridade com Dropdown */}
        <Popover open={showPriority} onOpenChange={setShowPriority}>
          <PopoverTrigger asChild>
            <motion.button
              whileHover={{ scale: 1.1 }}
              whileTap={{ scale: 0.9 }}
              onClick={(e) => e.stopPropagation()}
              className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
              title={t('tasks.row.setPriority')}
            >
              <Flag className="size-3.5" />
            </motion.button>
          </PopoverTrigger>
          <PopoverContent className="w-56 p-2" align="start">
            <div className="space-y-1">
              <div className="px-2 py-1 text-xs text-gray-500 dark:text-gray-400 font-medium">
                {t('tasks.priority.label')}
              </div>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  updateTask(task.id, { priority: 'urgent' });
                  toast.success('Prioridade definida: Urgente');
                  onUpdate();
                  setShowPriority(false);
                }}
                className="flex items-center gap-2 w-full px-3 py-2 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-800"
              >
                <Flag className="size-4 text-red-500" />
                <span className="dark:text-white">Urgente</span>
                {task.priority === 'urgent' && (
                  <CheckCircle2 className="size-4 ml-auto text-blue-600" />
                )}
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  updateTask(task.id, { priority: 'high' });
                  toast.success('Prioridade definida: Alta');
                  onUpdate();
                  setShowPriority(false);
                }}
                className="flex items-center gap-2 w-full px-3 py-2 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-800"
              >
                <Flag className="size-4 text-orange-500" />
                <span className="dark:text-white">Alta</span>
                {task.priority === 'high' && (
                  <CheckCircle2 className="size-4 ml-auto text-blue-600" />
                )}
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  updateTask(task.id, { priority: 'medium' });
                  toast.success('Prioridade definida: M√©dia');
                  onUpdate();
                  setShowPriority(false);
                }}
                className="flex items-center gap-2 w-full px-3 py-2 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-800"
              >
                <Flag className="size-4 text-yellow-500" />
                <span className="dark:text-white">M√©dia</span>
                {task.priority === 'medium' && (
                  <CheckCircle2 className="size-4 ml-auto text-blue-600" />
                )}
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  updateTask(task.id, { priority: 'low' });
                  toast.success('Prioridade definida: Baixa');
                  onUpdate();
                  setShowPriority(false);
                }}
                className="flex items-center gap-2 w-full px-3 py-2 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-800"
              >
                <Flag className="size-4 text-gray-500" />
                <span className="dark:text-white">Baixa</span>
                {task.priority === 'low' && (
                  <CheckCircle2 className="size-4 ml-auto text-blue-600" />
                )}
              </button>
            </div>
          </PopoverContent>
        </Popover>

        {/* Marcar como fechado com anima√ß√£o */}
        <Tooltip>
          <TooltipTrigger asChild>
            <motion.button
              whileHover={{ scale: 1.1 }}
              whileTap={{ scale: 0.9 }}
              onClick={handleStatusToggle}
              className="p-1 hover:bg-green-50 dark:hover:bg-green-950 rounded text-gray-500 hover:text-green-600 dark:hover:text-green-400"
            >
              <CheckCircle2 className="size-3.5" />
            </motion.button>
          </TooltipTrigger>
          <TooltipContent>
            <p>{task.status === 'done' ? t('tasks.toast.reopened') : t('tasks.row.markDone')}</p>
          </TooltipContent>
        </Tooltip>
      </div>
      </TooltipProvider>
    </div>
  );
}